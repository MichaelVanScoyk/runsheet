;; PgBouncer Configuration for CADReport
;; /etc/pgbouncer/pgbouncer.ini
;;
;; PgBouncer sits between the app and PostgreSQL:
;;   App → PgBouncer (port 6432) → PostgreSQL (port 5432)
;;
;; Transaction pooling: connections returned to pool at transaction boundary.
;; App gets a fresh connection each transaction, PgBouncer reuses real PG connections.

[databases]
;; Wildcard: any database name requested by the app gets proxied to localhost PostgreSQL.
;; This means new tenant databases (runsheet_newdept) work automatically — no config change needed.
* = host=127.0.0.1 port=5432

[pgbouncer]
;; ─── Listener ───
listen_addr = 127.0.0.1
listen_port = 6432

;; ─── Authentication ───
;; md5 auth using userlist.txt (password hashes)
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; ─── Pool Mode ───
;; transaction: connection returned to pool after each transaction commits/rollbacks.
;; This is the standard mode for web apps. Session-level SET commands reset between
;; transactions — but we don't use any (verified in Phase B contraindication check).
pool_mode = transaction

;; ─── Pool Sizing ───
;; max_client_conn: how many app connections PgBouncer accepts.
;; At 50 tenants with multi-worker backend, this needs headroom.
max_client_conn = 10000

;; default_pool_size: real PostgreSQL connections PER DATABASE.
;; With NullPool in SQLAlchemy, every app request opens/closes a PgBouncer connection.
;; PgBouncer maps those to this many real PG connections per database.
;; 50 is plenty for current scale; PG max_connections = 2000 gives room for ~40 databases.
default_pool_size = 50

;; min_pool_size: keep this many connections warm per database.
;; Avoids cold-start latency on first request after idle period.
min_pool_size = 5

;; reserve_pool_size: extra connections if default_pool is exhausted.
;; Temporary overflow — logged as warning so we know to increase default_pool_size.
reserve_pool_size = 10
reserve_pool_timeout = 3

;; ─── Timeouts ───
;; server_idle_timeout: close idle real PG connections after 10 min.
;; Keeps connection count low during quiet periods (overnight).
server_idle_timeout = 600

;; client_idle_timeout: close idle app connections after 5 min.
;; Catches leaked connections that apps forgot to close.
client_idle_timeout = 300

;; server_connect_timeout: give up connecting to PG after 5 sec.
server_connect_timeout = 5

;; query_timeout: kill queries running longer than 5 min.
;; Safety net — our queries should all complete in seconds.
query_timeout = 300

;; server_lifetime: recycle real PG connections after 1 hour.
;; Prevents stale connections from accumulating.
server_lifetime = 3600

;; ─── Logging ───
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /run/pgbouncer/pgbouncer.pid

;; Log connections and disconnections for debugging.
;; Turn off (set to 0) once stable to reduce log volume.
log_connections = 1
log_disconnections = 1

;; Stats period — log pool stats every 60 seconds.
stats_period = 60

;; ─── Admin Console ───
;; Connect with: psql -p 6432 -U pgbouncer pgbouncer
;; Then: SHOW POOLS; SHOW STATS; SHOW CLIENTS;
admin_users = pgbouncer
stats_users = pgbouncer,dashboard

;; ─── TCP Keepalive ───
;; Detect dead connections faster on the firehouse LAN.
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 3
